<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CMS</title>
  <style>
    /* Create a protected mounting environment */
    #cms-shield {
      all: initial; /* Isolate from parent styles */
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 9999;
      background: white;
    }
  </style>
</head>
<body>
  <!-- Protected mount point -->
  <div id="cms-shield">
    <div id="cms-root"></div>
  </div>

  <!-- Load CSS first -->
  <link rel="stylesheet" href="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.css">

  <!-- Load JS with defer -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js" defer></script>

  <!-- Robust initialization -->
  <script>
    (function() {
      const MAX_RETRIES = 10;
      let retryCount = 0;
      
      function initCMS() {
        try {
          const root = document.getElementById('cms-root');
          if (!root) throw new Error('Mount point not found');
          
          if (window.CMS) {
            // Create fresh mount point
            root.innerHTML = '';
            
            CMS.init({
              config: {
                backend: {
                  name: "github",
                  repo: "khaleeqrehman/portfolio-v2",
                  branch: "main"
                },
                media_folder: "static/images/uploads",
                public_folder: "/images/uploads",
                collections: [ /* your collections */ ]
              }
            });
          } else {
            throw new Error('CMS not loaded');
          }
        } catch (e) {
          if (retryCount < MAX_RETRIES) {
            retryCount++;
            console.warn(`Retry ${retryCount}/10:`, e.message);
            setTimeout(initCMS, 300 * retryCount);
          } else {
            console.error('CMS failed to initialize after 10 attempts');
            document.getElementById('cms-shield').innerHTML = `
              <div style="padding: 2rem; font-family: sans-serif;">
                <h2>CMS Loading Failed</h2>
                <p>Please refresh the page or try again later.</p>
                <button onclick="window.location.reload()">Retry</button>
              </div>
            `;
          }
        }
      }

      // Start initialization after everything loads
      window.addEventListener('load', initCMS);
    })();
  </script>
</body>
</html>